<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage
    BackgroundColor="{AppThemeBinding Light={StaticResource Light},
                                      Dark={StaticResource Gray950}}"
    Shell.NavBarIsVisible="False"
    Title="{Binding Title}"
    x:Class="AcuPuntos.Views.RewardsPage"
    x:DataType="viewmodels:RewardsViewModel"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:controls="clr-namespace:AcuPuntos.Views.Controls"
    xmlns:models="clr-namespace:AcuPuntos.Models"
    xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
    xmlns:views="clr-namespace:AcuPuntos.Views"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <Grid RowDefinitions="Auto,*">
        <!--  Header Background Shape  -->
        <BoxView
            Color="{StaticResource Primary}"
            Grid.RowSpan="2"
            HeightRequest="200"
            VerticalOptions="Start" />

        <RefreshView
            Command="{Binding RefreshRewardsCommand}"
            Grid.RowSpan="2"
            IsRefreshing="{Binding IsRefreshing}"
            RefreshColor="White">
            <ScrollView>
                <VerticalStackLayout Padding="24" Spacing="24">

                    <!--  Saldo actual  -->
                    <Grid Margin="0,10,0,0">
                        <Border
                            BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceAlpha},
                                                              Dark={StaticResource Gray900}}"
                            IsVisible="{Binding IsNotBusy}"
                            Padding="24"
                            StrokeThickness="0"
                            Style="{StaticResource CardFrame}">
                            <Grid ColumnDefinitions="*,Auto">
                                <VerticalStackLayout Spacing="4">
                                    <Label
                                        FontSize="14"
                                        Opacity="0.9"
                                        Text="Tus puntos disponibles"
                                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                                    Dark={StaticResource White}}" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontFamily="OpenSansBold"
                                        FontSize="42"
                                        Text="{Binding CurrentUser.Points, StringFormat='{0:N0}'}"
                                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDark},
                                                                    Dark={StaticResource PrimaryLight}}" />
                                </VerticalStackLayout>
                                <Label
                                    FontSize="56"
                                    Grid.Column="1"
                                    Text="游꾸"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>
                        <controls:CardSkeleton IsVisible="{Binding IsBusy}" />
                    </Grid>

                    <!--  B칰squeda  -->
                    <Border
                        BackgroundColor="{AppThemeBinding Light={StaticResource Surface},
                                                          Dark={StaticResource Gray900}}"
                        Padding="16"
                        Style="{StaticResource CardFrame}">
                        <VerticalStackLayout Spacing="12">
                            <SearchBar
                                BackgroundColor="{AppThemeBinding Light={StaticResource Background},
                                                                  Dark={StaticResource Gray800}}"
                                Placeholder="Buscar recompensas..."
                                PlaceholderColor="{StaticResource Gray400}"
                                Text="{Binding SearchText}"
                                TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                            Dark={StaticResource White}}" />

                            <!--  Filtro por categor칤a  -->
                            <HorizontalStackLayout Spacing="12">
                                <Label
                                    FontSize="14"
                                    Text="Categor칤a:"
                                    TextColor="{StaticResource Gray600}"
                                    VerticalOptions="Center" />
                                <Picker
                                    BackgroundColor="Transparent"
                                    HorizontalOptions="FillAndExpand"
                                    ItemsSource="{Binding Categories}"
                                    SelectedItem="{Binding SelectedCategory}"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                Dark={StaticResource White}}"
                                    TitleColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                 Dark={StaticResource White}}" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Border>

                    <!--  Lista de recompensas  -->
                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="Recompensas Disponibles"
                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                    Dark={StaticResource White}}" />

                    <VerticalStackLayout>
                        <CollectionView
                            IsVisible="{Binding IsNotBusy}"
                            ItemsSource="{Binding FilteredRewards}"
                            SelectionMode="None">
                            <CollectionView.EmptyView>
                                <controls:EmptyStateView Icon="游댌" Title="No hay recompensas disponibles" />
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Reward">
                                    <Border
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Surface},
                                                                          Dark={StaticResource Gray900}}"
                                        Margin="4,0,4,16"
                                        Padding="16"
                                        Style="{StaticResource CardFrame}">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ViewRewardDetailCommand}" CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Grid
                                            ColumnDefinitions="Auto,*,Auto"
                                            RowDefinitions="Auto,Auto,Auto,Auto"
                                            RowSpacing="8">

                                            <!--  Icono  -->
                                            <Border
                                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100},
                                                                                  Dark={StaticResource Gray800}}"
                                                Grid.Row="0"
                                                Grid.RowSpan="2"
                                                HeightRequest="64"
                                                StrokeShape="RoundRectangle 16"
                                                StrokeThickness="0"
                                                VerticalOptions="Start"
                                                WidthRequest="64">
                                                <Label
                                                    FontSize="32"
                                                    HorizontalOptions="Center"
                                                    Text="{Binding Icon, FallbackValue='游꾸'}"
                                                    VerticalOptions="Center" />
                                            </Border>

                                            <!--  Nombre y descripci칩n  -->
                                            <VerticalStackLayout
                                                Grid.Column="1"
                                                Grid.Row="0"
                                                Margin="16,0,0,0"
                                                Spacing="4">
                                                <Label
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    Text="{Binding Name}"
                                                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                                Dark={StaticResource White}}" />
                                                <Label
                                                    FontSize="13"
                                                    LineBreakMode="TailTruncation"
                                                    MaxLines="2"
                                                    Text="{Binding Description}"
                                                    TextColor="{StaticResource Gray500}" />
                                            </VerticalStackLayout>

                                            <!--  Costo en puntos  -->
                                            <Border
                                                BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryLight},
                                                                                  Dark={StaticResource PrimaryDark}}"
                                                Grid.Column="2"
                                                Grid.Row="0"
                                                Padding="12,6"
                                                StrokeShape="RoundRectangle 12"
                                                StrokeThickness="0"
                                                VerticalOptions="Start">
                                                <Label
                                                    FontAttributes="Bold"
                                                    FontSize="14"
                                                    Text="{Binding PointsCost, StringFormat='{0:N0}'}"
                                                    TextColor="{AppThemeBinding Light={StaticResource PrimaryDark},
                                                                                Dark={StaticResource White}}" />
                                            </Border>

                                            <!--  Categor칤a  -->
                                            <Border
                                                BackgroundColor="{AppThemeBinding Light={StaticResource SecondaryLight},
                                                                                  Dark={StaticResource SecondaryDark}}"
                                                Grid.Column="1"
                                                Grid.ColumnSpan="2"
                                                Grid.Row="1"
                                                HorizontalOptions="Start"
                                                Margin="16,4,0,0"
                                                Padding="8,4"
                                                StrokeShape="RoundRectangle 8"
                                                StrokeThickness="0">
                                                <Label
                                                    FontAttributes="Bold"
                                                    FontSize="11"
                                                    Text="{Binding Category}"
                                                    TextColor="{AppThemeBinding Light={StaticResource SecondaryDark},
                                                                                Dark={StaticResource White}}"
                                                    TextTransform="Uppercase" />
                                            </Border>

                                            <!--  Bot칩n de canje  -->
                                            <Button
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RedeemRewardCommand}"
                                                CommandParameter="{Binding .}"
                                                CornerRadius="12"
                                                Grid.ColumnSpan="3"
                                                Grid.Row="3"
                                                HeightRequest="44"
                                                IsEnabled="{Binding CanRedeem}"
                                                Margin="0,12,0,0"
                                                Style="{StaticResource PrimaryButton}"
                                                Text="Canjear">
                                                <Button.Triggers>
                                                    <DataTrigger
                                                        Binding="{Binding CanRedeem}"
                                                        TargetType="Button"
                                                        Value="False">
                                                        <Setter Property="BackgroundColor" Value="{StaticResource Gray200}" />
                                                        <Setter Property="TextColor" Value="{StaticResource Gray500}" />
                                                        <Setter Property="Text" Value="{Binding DisabledReason}" />
                                                    </DataTrigger>
                                                </Button.Triggers>
                                            </Button>

                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!--  Skeleton Loading  -->
                        <controls:SkeletonList IsVisible="{Binding IsBusy}" />
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>
    </Grid>
</views:BasePage>
