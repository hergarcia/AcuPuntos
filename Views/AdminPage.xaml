<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage
    BackgroundColor="{StaticResource Light}"
    Shell.NavBarIsVisible="True"
    Shell.TabBarIsVisible="False"
    Title="{Binding Title}"
    x:Class="AcuPuntos.Views.AdminPage"
    x:DataType="viewmodels:AdminViewModel"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:models="clr-namespace:AcuPuntos.Models"
    xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
    xmlns:views="clr-namespace:AcuPuntos.Views"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!--  EstadÃ­sticas rÃ¡pidas  -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <!--  Total usuarios  -->
                <Border
                    BackgroundColor="{StaticResource Secondary}"
                    Grid.Column="0"
                    Padding="15"
                    Style="{StaticResource CardFrame}">
                    <VerticalStackLayout Spacing="5">
                        <Label
                            FontSize="30"
                            HorizontalOptions="Center"
                            Text="ðŸ‘¥" />
                        <Label
                            FontSize="12"
                            HorizontalOptions="Center"
                            Text="Usuarios"
                            TextColor="White" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="26"
                            HorizontalOptions="Center"
                            Text="{Binding TotalUsers}"
                            TextColor="White" />
                    </VerticalStackLayout>
                </Border>

                <!--  Canjes pendientes  -->
                <Border
                    BackgroundColor="{StaticResource Warning}"
                    Grid.Column="1"
                    Padding="15"
                    Style="{StaticResource CardFrame}">
                    <VerticalStackLayout Spacing="5">
                        <Label
                            FontSize="30"
                            HorizontalOptions="Center"
                            Text="â³" />
                        <Label
                            FontSize="12"
                            HorizontalOptions="Center"
                            Text="Pendientes"
                            TextColor="White" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="26"
                            HorizontalOptions="Center"
                            Text="{Binding PendingRedemptionsCount}"
                            TextColor="White" />
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <!--  Canjes pendientes  -->
            <Label
                FontAttributes="Bold"
                FontSize="20"
                Text="â³ Canjes Pendientes"
                TextColor="{StaticResource Dark}" />

            <CollectionView
                HeightRequest="250"
                ItemsSource="{Binding PendingRedemptions}"
                SelectionMode="None">
                <CollectionView.EmptyView>
                    <Border Padding="30" Style="{StaticResource CardFrame}">
                        <VerticalStackLayout Spacing="10">
                            <Label
                                FontSize="40"
                                HorizontalOptions="Center"
                                Text="âœ…" />
                            <Label
                                FontSize="14"
                                HorizontalOptions="Center"
                                Text="No hay canjes pendientes"
                                TextColor="{StaticResource Gray}" />
                        </VerticalStackLayout>
                    </Border>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Redemption">
                        <Border
                            Margin="0,0,0,10"
                            Padding="15"
                            Style="{StaticResource ListItemCard}">
                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">

                                <Label
                                    FontSize="40"
                                    Grid.Row="0"
                                    Grid.RowSpan="2"
                                    Text="ðŸŽ"
                                    VerticalOptions="Center" />

                                <VerticalStackLayout
                                    Grid.Column="1"
                                    Grid.Row="0"
                                    Margin="15,0,0,0">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="{Binding Reward.Name}"
                                        TextColor="{StaticResource Dark}" />
                                    <Label
                                        FontSize="14"
                                        Text="{Binding User.DisplayName}"
                                        TextColor="{StaticResource Gray}" />
                                    <Label
                                        FontSize="12"
                                        Text="{Binding RedeemedAt, StringFormat='Canjeado: {0:dd/MM/yyyy HH:mm}'}"
                                        TextColor="{StaticResource Gray400}" />
                                </VerticalStackLayout>

                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Grid.Column="2"
                                    Grid.Row="0"
                                    Text="{Binding PointsUsed, StringFormat='{0:N0} pts'}"
                                    TextColor="{StaticResource Warning}"
                                    VerticalOptions="Start" />

                                <HorizontalStackLayout
                                    Grid.ColumnSpan="3"
                                    Grid.Row="2"
                                    Margin="0,10,0,0"
                                    Spacing="10">
                                    <Button
                                        BackgroundColor="{StaticResource Primary}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ApproveRedemptionCommand}"
                                        CommandParameter="{Binding .}"
                                        CornerRadius="17"
                                        FontSize="12"
                                        HeightRequest="35"
                                        HorizontalOptions="FillAndExpand"
                                        Text="âœ… Aprobar"
                                        TextColor="White" />
                                    <Button
                                        BackgroundColor="{StaticResource Danger}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RejectRedemptionCommand}"
                                        CommandParameter="{Binding .}"
                                        CornerRadius="17"
                                        FontSize="12"
                                        HeightRequest="35"
                                        HorizontalOptions="FillAndExpand"
                                        Text="âŒ Rechazar"
                                        TextColor="White" />
                                </HorizontalStackLayout>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!--  GestiÃ³n de usuarios  -->
            <Label
                FontAttributes="Bold"
                FontSize="20"
                Margin="0,20,0,0"
                Text="ðŸ‘¥ GestiÃ³n de Usuarios"
                TextColor="{StaticResource Dark}" />

            <SearchBar
                BackgroundColor="White"
                Placeholder="Buscar usuarios..."
                PlaceholderColor="#999999"
                Text="{Binding SearchText}" />

            <CollectionView ItemsSource="{Binding Users}" SelectionMode="None">
                <CollectionView.EmptyView>
                    <Border Padding="30" Style="{StaticResource CardFrame}">
                        <Label
                            FontSize="14"
                            HorizontalOptions="Center"
                            Text="No hay usuarios"
                            TextColor="{StaticResource Gray}" />
                    </Border>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:User">
                        <Border
                            Margin="0,0,0,10"
                            Padding="15"
                            Style="{StaticResource ListItemCard}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ViewUserDetailCommand}" CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">

                                <Border
                                    BackgroundColor="{StaticResource Gray200}"
                                    Grid.Row="0"
                                    Grid.RowSpan="2"
                                    HeightRequest="55"
                                    StrokeShape="RoundRectangle 28"
                                    StrokeThickness="2"
                                    VerticalOptions="Center"
                                    WidthRequest="55">
                                    <Image
                                        Aspect="AspectFill"
                                        Source="{Binding PhotoUrl, TargetNullValue='user_placeholder.svg', FallbackValue='user_placeholder.svg'}" />
                                </Border>

                                <VerticalStackLayout
                                    Grid.Column="1"
                                    Grid.Row="0"
                                    Margin="15,0,0,0">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="{Binding DisplayName}"
                                        TextColor="{StaticResource Dark}" />
                                    <Label
                                        FontSize="12"
                                        Text="{Binding Email}"
                                        TextColor="{StaticResource Gray}" />
                                </VerticalStackLayout>

                                <VerticalStackLayout Grid.Column="2" Grid.Row="0">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="20"
                                        HorizontalOptions="End"
                                        Text="{Binding Points, StringFormat='{0:N0}'}"
                                        TextColor="{StaticResource Primary}" />
                                    <Label
                                        FontSize="12"
                                        HorizontalOptions="End"
                                        Text="puntos"
                                        TextColor="{StaticResource Gray400}" />
                                </VerticalStackLayout>

                                <Button
                                    BackgroundColor="{StaticResource Secondary}"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.AssignPointsCommand}"
                                    CommandParameter="{Binding .}"
                                    CornerRadius="17"
                                    FontSize="12"
                                    Grid.Column="1"
                                    Grid.ColumnSpan="2"
                                    Grid.Row="1"
                                    HeightRequest="35"
                                    Margin="15,10,0,0"
                                    Text="ðŸ’° Asignar Puntos"
                                    TextColor="White" />

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!--  Botones de inicializaciÃ³n del sistema  -->
            <Label
                FontAttributes="Bold"
                FontSize="18"
                Margin="0,20,0,10"
                Text="âš™ï¸ ConfiguraciÃ³n del Sistema"
                TextColor="{StaticResource Dark}" />

            <Button
                BackgroundColor="{StaticResource Tertiary}"
                Command="{Binding InitializeBadgesCommand}"
                CornerRadius="25"
                FontAttributes="Bold"
                HeightRequest="50"
                Margin="0,0,0,10"
                Text="ðŸŽ–ï¸ Inicializar Badges del Sistema"
                TextColor="White" />

            <Button
                BackgroundColor="{StaticResource Secondary}"
                Command="{Binding InitializeRewardsCommand}"
                CornerRadius="25"
                FontAttributes="Bold"
                HeightRequest="50"
                Margin="0,0,0,20"
                Text="ðŸŽ Inicializar Recompensas del Sistema"
                TextColor="White" />

        </VerticalStackLayout>
    </ScrollView>

    <!--  Loading Overlay  -->
    <Grid IsVisible="{Binding IsBusy}"
          BackgroundColor="#80000000"
          VerticalOptions="Fill"
          HorizontalOptions="Fill">
        <VerticalStackLayout
            VerticalOptions="Center"
            HorizontalOptions="Center"
            Spacing="15">
            <ActivityIndicator
                IsRunning="{Binding IsBusy}"
                Color="{StaticResource Primary}"
                WidthRequest="50"
                HeightRequest="50"/>
            <Label
                Text="{Binding Subtitle}"
                TextColor="White"
                FontSize="16"
                HorizontalTextAlignment="Center"
                IsVisible="{Binding Subtitle, Converter={StaticResource StringToBoolConverter}}"/>
        </VerticalStackLayout>
    </Grid>
</views:BasePage>
