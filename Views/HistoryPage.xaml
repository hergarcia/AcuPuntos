<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage
    BackgroundColor="#F5F5F5"
    Shell.NavBarIsVisible="True"
    Shell.TabBarIsVisible="False"
    Title="{Binding Title}"
    x:Class="AcuPuntos.Views.HistoryPage"
    x:DataType="viewmodels:HistoryViewModel"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:models="clr-namespace:AcuPuntos.Models"
    xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
    xmlns:views="clr-namespace:AcuPuntos.Views"
    xmlns:controls="clr-namespace:AcuPuntos.Views.Controls"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <Grid>
        <RefreshView Command="{Binding RefreshHistoryCommand}">
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="20">

            <!--  EstadÃ­sticas  -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                <!--  Puntos ganados  -->
                <controls:StatsCard
                    Grid.Column="0"
                    Value="{Binding TotalPointsEarned}"
                    Label="Ganados"
                    Icon="ðŸ“ˆ"
                    BackgroundColor="#2ECC71"
                    LabelColor="White"
                    ValueColor="White"/>

                <!--  Puntos gastados  -->
                <controls:StatsCard
                    Grid.Column="1"
                    Value="{Binding TotalPointsSpent}"
                    Label="Gastados"
                    Icon="ðŸ“‰"
                    BackgroundColor="#E74C3C"
                    LabelColor="White"
                    ValueColor="White"/>
            </Grid>

            <!--  Filtros  -->
            <Border Padding="15" Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="10">
                    <SearchBar
                        BackgroundColor="#F5F5F5"
                        Placeholder="Buscar en historial..."
                        PlaceholderColor="#999999"
                        Text="{Binding SearchText}" />

                    <HorizontalStackLayout Spacing="10">
                        <Label
                            FontSize="14"
                            Text="Filtrar:"
                            TextColor="#666666"
                            VerticalOptions="Center" />
                        <Picker
                            BackgroundColor="#F5F5F5"
                            HorizontalOptions="FillAndExpand"
                            ItemsSource="{Binding Filters}"
                            SelectedItem="{Binding SelectedFilter}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>

            <!--  Lista de transacciones  -->
            <Label
                FontAttributes="Bold"
                FontSize="16"
                Text="{Binding TotalTransactions, StringFormat='Total: {0} transacciones'}"
                TextColor="#666666" />

            <CollectionView ItemsSource="{Binding FilteredTransactions}" SelectionMode="None">
                <CollectionView.EmptyView>
                    <controls:EmptyStateView
                        Icon="ðŸ“Š"
                        Title="No hay transacciones"/>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Transaction">
                        <Border
                            Margin="0,0,0,10"
                            Padding="15"
                            Style="{StaticResource ListItemCard}">
                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">

                                <!--  Icono segÃºn tipo  -->
                                <Label
                                    FontSize="40"
                                    Grid.Row="0"
                                    Grid.RowSpan="2"
                                    Text="{Binding Type, Converter={StaticResource TransactionIconConverter}}"
                                    VerticalOptions="Center" />

                                <!--  DescripciÃ³n  -->
                                <VerticalStackLayout
                                    Grid.Column="1"
                                    Grid.Row="0"
                                    Margin="15,0,0,0">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        LineBreakMode="TailTruncation"
                                        MaxLines="2"
                                        Text="{Binding Description}"
                                        TextColor="#333333" />
                                    <Label
                                        FontSize="12"
                                        Text="{Binding CreatedAt, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                        TextColor="{StaticResource Gray400}" />
                                </VerticalStackLayout>

                                <!--  Monto  -->
                                <VerticalStackLayout
                                    Grid.Column="2"
                                    Grid.Row="0"
                                    HorizontalOptions="End">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="20"
                                        HorizontalOptions="End"
                                        Text="{Binding Amount, StringFormat='{0:+#,0;-#,0;0}'}"
                                        TextColor="{Binding Type, Converter={StaticResource TransactionColorConverter}}" />
                                    <Label
                                        FontSize="12"
                                        HorizontalOptions="End"
                                        Text="puntos"
                                        TextColor="{StaticResource Gray400}" />
                                </VerticalStackLayout>

                                <!--  Tipo de transacciÃ³n  -->
                                <Border
                                    BackgroundColor="{Binding Type, Converter={StaticResource TransactionColorConverter}}"
                                    Grid.ColumnSpan="3"
                                    Grid.Row="2"
                                    HorizontalOptions="Start"
                                    Margin="0,10,0,0"
                                    Padding="8,4"
                                    StrokeShape="RoundRectangle 10">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="12"
                                        Text="{Binding Type, Converter={StaticResource TransactionTypeConverter}}"
                                        TextColor="White" />
                                </Border>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            </VerticalStackLayout>
        </ScrollView>
        </RefreshView>

        <!--  Loading Overlay Reutilizable  -->
        <controls:LoadingOverlay />
    </Grid>
</views:BasePage>
