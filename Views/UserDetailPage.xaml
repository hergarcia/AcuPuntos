<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage
    BackgroundColor="{StaticResource Light}"
    Shell.NavBarIsVisible="True"
    Shell.TabBarIsVisible="False"
    Title="{Binding Title}"
    x:Class="AcuPuntos.Views.UserDetailPage"
    x:DataType="viewmodels:UserDetailViewModel"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:models="clr-namespace:AcuPuntos.Models"
    xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
    xmlns:views="clr-namespace:AcuPuntos.Views"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!--  Perfil del usuario  -->
            <Border
                BackgroundColor="{StaticResource Secondary}"
                Padding="25"
                Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="15">

                    <!--  Foto de perfil circular  -->
                    <Border
                        BackgroundColor="White"
                        HeightRequest="90"
                        HorizontalOptions="Center"
                        StrokeShape="RoundRectangle 45"
                        StrokeThickness="3"
                        WidthRequest="90">
                        <Image Aspect="AspectFill" Source="{Binding User.PhotoUrl, TargetNullValue='user_placeholder.svg', FallbackValue='user_placeholder.svg'}" />
                    </Border>

                    <Label
                        FontAttributes="Bold"
                        FontSize="22"
                        HorizontalOptions="Center"
                        Text="{Binding User.DisplayName}"
                        TextColor="White" />

                    <Label
                        FontSize="14"
                        HorizontalOptions="Center"
                        Opacity="0.9"
                        Text="{Binding User.Email}"
                        TextColor="White" />

                    <Border
                        BackgroundColor="White"
                        HorizontalOptions="Center"
                        Padding="8,4"
                        StrokeShape="RoundRectangle 12">
                        <Label
                            FontAttributes="Bold"
                            FontSize="12"
                            Text="{Binding User.Role}"
                            TextColor="{StaticResource Secondary}" />
                    </Border>

                </VerticalStackLayout>
            </Border>

            <!--  Puntos actuales  -->
            <Border
                BackgroundColor="{StaticResource Primary}"
                Padding="20"
                Style="{StaticResource CardFrame}">
                <Grid ColumnDefinitions="*,Auto">
                    <VerticalStackLayout>
                        <Label
                            FontSize="16"
                            Opacity="0.9"
                            Text="Puntos Actuales"
                            TextColor="White" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="34"
                            Text="{Binding User.Points, StringFormat='{0:N0}'}"
                            TextColor="White" />
                    </VerticalStackLayout>
                    <Label
                        FontSize="55"
                        Grid.Column="1"
                        Text="ðŸ’°"
                        VerticalOptions="Center" />
                </Grid>
            </Border>

            <!--  EstadÃ­sticas  -->
            <Border Padding="20" Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="15">

                    <Label
                        FontAttributes="Bold"
                        FontSize="20"
                        Text="ðŸ“Š EstadÃ­sticas"
                        TextColor="{StaticResource Dark}" />

                    <Grid
                        ColumnDefinitions="*,*"
                        ColumnSpacing="12"
                        RowDefinitions="Auto,Auto"
                        RowSpacing="12">

                        <Border
                            BackgroundColor="{StaticResource Gray100}"
                            Grid.Column="0"
                            Grid.Row="0"
                            Padding="15"
                            StrokeShape="RoundRectangle 12">
                            <VerticalStackLayout Spacing="5">
                                <Label
                                    FontSize="28"
                                    HorizontalOptions="Center"
                                    Text="ðŸ“" />
                                <Label
                                    FontSize="11"
                                    HorizontalOptions="Center"
                                    Text="Transacciones"
                                    TextColor="{StaticResource Gray}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="22"
                                    HorizontalOptions="Center"
                                    Text="{Binding TotalTransactions}"
                                    TextColor="{StaticResource Primary}" />
                            </VerticalStackLayout>
                        </Border>

                        <Border
                            BackgroundColor="{StaticResource Gray100}"
                            Grid.Column="1"
                            Grid.Row="0"
                            Padding="15"
                            StrokeShape="RoundRectangle 12">
                            <VerticalStackLayout Spacing="5">
                                <Label
                                    FontSize="28"
                                    HorizontalOptions="Center"
                                    Text="ðŸŽ" />
                                <Label
                                    FontSize="11"
                                    HorizontalOptions="Center"
                                    Text="Canjes"
                                    TextColor="{StaticResource Gray}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="22"
                                    HorizontalOptions="Center"
                                    Text="{Binding TotalRedemptions}"
                                    TextColor="{StaticResource Warning}" />
                            </VerticalStackLayout>
                        </Border>

                        <Border
                            BackgroundColor="{StaticResource Gray100}"
                            Grid.Column="0"
                            Grid.Row="1"
                            Padding="15"
                            StrokeShape="RoundRectangle 12">
                            <VerticalStackLayout Spacing="5">
                                <Label
                                    FontSize="28"
                                    HorizontalOptions="Center"
                                    Text="ðŸ“ˆ" />
                                <Label
                                    FontSize="11"
                                    HorizontalOptions="Center"
                                    Text="Ganados"
                                    TextColor="{StaticResource Gray}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="22"
                                    HorizontalOptions="Center"
                                    Text="{Binding TotalPointsEarned, StringFormat='{0:N0}'}"
                                    TextColor="{StaticResource Secondary}" />
                            </VerticalStackLayout>
                        </Border>

                        <Border
                            BackgroundColor="{StaticResource Gray100}"
                            Grid.Column="1"
                            Grid.Row="1"
                            Padding="15"
                            StrokeShape="RoundRectangle 12">
                            <VerticalStackLayout Spacing="5">
                                <Label
                                    FontSize="28"
                                    HorizontalOptions="Center"
                                    Text="ðŸ“‰" />
                                <Label
                                    FontSize="11"
                                    HorizontalOptions="Center"
                                    Text="Gastados"
                                    TextColor="{StaticResource Gray}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="22"
                                    HorizontalOptions="Center"
                                    Text="{Binding TotalPointsSpent, StringFormat='{0:N0}'}"
                                    TextColor="{StaticResource Danger}" />
                            </VerticalStackLayout>
                        </Border>

                    </Grid>

                </VerticalStackLayout>
            </Border>

            <!--  InformaciÃ³n de cuenta  -->
            <Border Padding="20" Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="12">

                    <Label
                        FontAttributes="Bold"
                        FontSize="18"
                        Text="â„¹ï¸ InformaciÃ³n de Cuenta"
                        TextColor="{StaticResource Dark}" />

                    <HorizontalStackLayout Spacing="10">
                        <Label
                            FontSize="14"
                            Text="Miembro desde:"
                            TextColor="{StaticResource Gray}"
                            VerticalOptions="Center" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="14"
                            Text="{Binding User.CreatedAt, StringFormat='{0:dd/MM/yyyy}'}"
                            TextColor="{StaticResource Dark}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Spacing="10">
                        <Label
                            FontSize="12"
                            Text="UID:"
                            TextColor="{StaticResource Gray400}"
                            VerticalOptions="Center" />
                        <Label
                            FontSize="11"
                            HorizontalOptions="FillAndExpand"
                            LineBreakMode="TailTruncation"
                            Text="{Binding User.Uid}"
                            TextColor="{StaticResource Gray400}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>

                </VerticalStackLayout>
            </Border>

            <!--  Transacciones recientes  -->
            <Label
                FontAttributes="Bold"
                FontSize="18"
                Text="ðŸ“ Transacciones Recientes"
                TextColor="{StaticResource Dark}" />

            <CollectionView
                HeightRequest="300"
                ItemsSource="{Binding RecentTransactions}"
                SelectionMode="None">
                <CollectionView.EmptyView>
                    <Border Padding="30" Style="{StaticResource CardFrame}">
                        <Label
                            FontSize="14"
                            HorizontalOptions="Center"
                            Text="No hay transacciones"
                            TextColor="{StaticResource Gray}" />
                    </Border>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Transaction">
                        <Border
                            Margin="0,0,0,8"
                            Padding="12"
                            Style="{StaticResource ListItemCard}">
                            <Grid ColumnDefinitions="Auto,*,Auto">

                                <Label
                                    FontSize="32"
                                    Text="{Binding Type, Converter={StaticResource TransactionIconConverter}}"
                                    VerticalOptions="Center" />

                                <VerticalStackLayout Grid.Column="1" Margin="12,0,0,0">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="14"
                                        LineBreakMode="TailTruncation"
                                        Text="{Binding Description}"
                                        TextColor="{StaticResource Dark}" />
                                    <Label
                                        FontSize="11"
                                        Text="{Binding CreatedAt, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                        TextColor="{StaticResource Gray400}" />
                                </VerticalStackLayout>

                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Grid.Column="2"
                                    Text="{Binding Amount, StringFormat='{0:+#,0;-#,0;0}'}"
                                    TextColor="{Binding Type, Converter={StaticResource TransactionColorConverter}}"
                                    VerticalOptions="Center" />

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!--  Botones de acciÃ³n  -->
            <Button
                BackgroundColor="{StaticResource Primary}"
                Command="{Binding AssignPointsCommand}"
                CornerRadius="25"
                FontAttributes="Bold"
                HeightRequest="50"
                Margin="0,0,0,20"
                Text="ðŸ’° Asignar Puntos"
                TextColor="White" />

        </VerticalStackLayout>
    </ScrollView>
</views:BasePage>
