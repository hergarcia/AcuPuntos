<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage
    BackgroundColor="{StaticResource Light}"
    Title="{Binding Title}"
    x:Class="AcuPuntos.Views.TransferPage"
    x:DataType="viewmodels:TransferViewModel"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:models="clr-namespace:AcuPuntos.Models"
    xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
    xmlns:views="clr-namespace:AcuPuntos.Views"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!--  Card de saldo actual  -->
            <Border
                BackgroundColor="{StaticResource Primary}"
                Padding="20"
                Style="{StaticResource CardFrame}">
                <Grid ColumnDefinitions="*,Auto">
                    <VerticalStackLayout>
                        <Label
                            FontSize="14"
                            Opacity="0.9"
                            Text="Tu saldo actual"
                            TextColor="White" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="32"
                            Text="{Binding CurrentUser.Points, StringFormat='{0:N0} puntos'}"
                            TextColor="White" />
                    </VerticalStackLayout>
                    <Label
                        FontSize="50"
                        Grid.Column="1"
                        Text="ðŸ’°"
                        VerticalOptions="Center" />
                </Grid>
            </Border>

            <!--  Formulario de transferencia  -->
            <Border Padding="20" Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="20">

                    <Label
                        FontAttributes="Bold"
                        FontSize="22"
                        Text="Transferir Puntos"
                        TextColor="{StaticResource Dark}" />

                    <!--  Campo de bÃºsqueda  -->
                    <VerticalStackLayout Spacing="5">
                        <Label
                            FontSize="14"
                            Text="Buscar usuario"
                            TextColor="{StaticResource Gray}" />
                        <SearchBar
                            BackgroundColor="{StaticResource Light}"
                            Placeholder="Nombre o email..."
                            PlaceholderColor="#999999"
                            Text="{Binding SearchText}" />
                    </VerticalStackLayout>

                    <!--  Lista de usuarios  -->
                    <Border
                        BackgroundColor="{StaticResource Light}"
                        HeightRequest="200"
                        Padding="5"
                        Stroke="#E0E0E0"
                        StrokeShape="RoundRectangle 10">
                        <ScrollView>
                            <CollectionView ItemsSource="{Binding FilteredUsers}" SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:User">
                                        <Border Margin="5"
                                               Padding="15"
                                               BackgroundColor="White"
                                               StrokeShape="RoundRectangle 10"
                                               StrokeThickness="2">
                                            <Border.Stroke>
                                                <MultiBinding Converter="{StaticResource UserSelectionConverter}">
                                                    <Binding Path="Uid" />
                                                    <Binding Path="BindingContext.SelectedUser.Uid" Source="{RelativeSource AncestorType={x:Type ContentPage}}" />
                                                </MultiBinding>
                                            </Border.Stroke>
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectUserCommand}"
                                                    CommandParameter="{Binding .}"/>
                                            </Border.GestureRecognizers>
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border
                                                    BackgroundColor="{StaticResource Gray200}"
                                                    HeightRequest="50"
                                                    StrokeShape="RoundRectangle 25"
                                                    StrokeThickness="2"
                                                    VerticalOptions="Center"
                                                    WidthRequest="50">
                                                    <Image Aspect="AspectFill" Source="{Binding PhotoUrl, TargetNullValue='user_placeholder.svg', FallbackValue='user_placeholder.svg'}" />
                                                </Border>
                                                <VerticalStackLayout Grid.Column="1" Margin="10,0,0,0">
                                                    <Label
                                                        FontAttributes="Bold"
                                                        FontSize="16"
                                                        Text="{Binding DisplayName}"
                                                        TextColor="{StaticResource Dark}" />
                                                    <Label
                                                        FontSize="12"
                                                        Text="{Binding Email}"
                                                        TextColor="{StaticResource Gray}" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </ScrollView>
                    </Border>

                    <!--  Usuario seleccionado  -->
                    <Border
                        BackgroundColor="{StaticResource Gray100}"
                        IsVisible="{Binding SelectedUser, Converter={StaticResource NullToBoolConverter}}"
                        Padding="15"
                        Stroke="#2ECC71"
                        StrokeShape="RoundRectangle 10">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label
                                FontSize="25"
                                Text="âœ…"
                                VerticalOptions="Center" />
                            <VerticalStackLayout Grid.Column="1" Margin="10,0">
                                <Label
                                    FontSize="12"
                                    Text="Enviar a:"
                                    TextColor="{StaticResource Gray}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding SelectedUser.DisplayName}"
                                    TextColor="{StaticResource Primary}" />
                            </VerticalStackLayout>
                            <Button
                                BackgroundColor="Transparent"
                                Command="{Binding SelectUserCommand}"
                                CommandParameter="{x:Null}"
                                FontSize="20"
                                Grid.Column="2"
                                HeightRequest="40"
                                Padding="0"
                                Text="âœ•"
                                TextColor="{StaticResource Danger}"
                                WidthRequest="40" />
                        </Grid>
                    </Border>

                    <!--  Cantidad de puntos  -->
                    <VerticalStackLayout Spacing="5">
                        <Label
                            FontSize="14"
                            Text="Cantidad de puntos"
                            TextColor="{StaticResource Gray}" />
                        <Entry
                            BackgroundColor="{StaticResource Light}"
                            Keyboard="Numeric"
                            Placeholder="Ingresa la cantidad..."
                            Text="{Binding PointsToTransfer}" />
                    </VerticalStackLayout>

                    <!--  DescripciÃ³n (opcional)  -->
                    <VerticalStackLayout Spacing="5">
                        <Label
                            FontSize="14"
                            Text="Mensaje (opcional)"
                            TextColor="{StaticResource Gray}" />
                        <Editor
                            BackgroundColor="{StaticResource Light}"
                            HeightRequest="80"
                            Placeholder="AÃ±ade un mensaje..."
                            Text="{Binding Description}" />
                    </VerticalStackLayout>

                    <!--  Mensaje de error  -->
                    <Label
                        FontSize="14"
                        HorizontalOptions="Center"
                        IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                        Text="{Binding ErrorMessage}"
                        TextColor="{StaticResource Danger}" />

                    <!--  BotÃ³n de transferir  -->
                    <Button
                        BackgroundColor="{StaticResource Primary}"
                        Command="{Binding TransferPointsCommand}"
                        CornerRadius="25"
                        FontAttributes="Bold"
                        HeightRequest="50"
                        IsEnabled="{Binding CanTransfer}"
                        Text="Transferir Puntos"
                        TextColor="White">
                        <Button.Triggers>
                            <DataTrigger
                                Binding="{Binding CanTransfer}"
                                TargetType="Button"
                                Value="False">
                                <Setter Property="BackgroundColor" Value="#95A5A6" />
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>

                </VerticalStackLayout>
            </Border>

            <!--  InformaciÃ³n adicional  -->
            <Border
                BackgroundColor="#FFF9E6"
                Padding="15"
                Style="{StaticResource CardFrame}">
                <Grid ColumnDefinitions="Auto,*">
                    <Label FontSize="25" Text="ðŸ’¡" />
                    <VerticalStackLayout Grid.Column="1" Margin="10,0,0,0">
                        <Label
                            FontAttributes="Bold"
                            FontSize="14"
                            Text="InformaciÃ³n"
                            TextColor="{StaticResource Warning}" />
                        <Label
                            FontSize="12"
                            Text="Las transferencias son instantÃ¡neas y no se pueden revertir. AsegÃºrate de seleccionar el usuario correcto."
                            TextColor="{StaticResource Gray}" />
                    </VerticalStackLayout>
                </Grid>
            </Border>

        </VerticalStackLayout>
    </ScrollView>

    <!--  Loading Overlay  -->
    <Grid IsVisible="{Binding IsBusy}"
          BackgroundColor="#80000000"
          VerticalOptions="Fill"
          HorizontalOptions="Fill">
        <VerticalStackLayout
            VerticalOptions="Center"
            HorizontalOptions="Center"
            Spacing="15">
            <ActivityIndicator
                IsRunning="{Binding IsBusy}"
                Color="{StaticResource Primary}"
                WidthRequest="50"
                HeightRequest="50"/>
            <Label
                Text="{Binding Subtitle}"
                TextColor="White"
                FontSize="16"
                HorizontalTextAlignment="Center"
                IsVisible="{Binding Subtitle, Converter={StaticResource StringToBoolConverter}}"/>
        </VerticalStackLayout>
    </Grid>
</views:BasePage>
