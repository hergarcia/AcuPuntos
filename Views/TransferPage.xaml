<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:AcuPuntos.Views"
             xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
             xmlns:models="clr-namespace:AcuPuntos.Models"
             x:Class="AcuPuntos.Views.TransferPage"
             x:DataType="viewmodels:TransferViewModel"
             Title="{Binding Title}"
             BackgroundColor="{StaticResource Light}">

    <ScrollView>
        <VerticalStackLayout Spacing="20" Padding="20">
            
            <!-- Card de saldo actual -->
            <Border Style="{StaticResource CardFrame}"
                   BackgroundColor="{StaticResource Primary}"
                   Padding="20">
                <Grid ColumnDefinitions="*,Auto">
                    <VerticalStackLayout>
                        <Label Text="Tu saldo actual"
                               TextColor="White"
                               FontSize="14"
                               Opacity="0.9"/>
                        <Label Text="{Binding CurrentUser.Points, StringFormat='{0:N0} puntos'}"
                               TextColor="White"
                               FontSize="32"
                               FontAttributes="Bold"/>
                    </VerticalStackLayout>
                    <Label Grid.Column="1"
                           Text="ðŸ’°"
                           FontSize="50"
                           VerticalOptions="Center"/>
                </Grid>
            </Border>

            <!-- Formulario de transferencia -->
            <Border Style="{StaticResource CardFrame}"
                   Padding="20">
                <VerticalStackLayout Spacing="20">
                    
                    <Label Text="Transferir Puntos"
                           FontSize="22"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Dark}"/>
                    
                    <!-- Campo de bÃºsqueda -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Buscar usuario"
                               FontSize="14"
                               TextColor="{StaticResource Gray}"/>
                        <SearchBar Placeholder="Nombre o email..."
                                   Text="{Binding SearchText}"
                                   BackgroundColor="{StaticResource Light}"
                                   PlaceholderColor="#999999"/>
                    </VerticalStackLayout>

                    <!-- Lista de usuarios -->
                    <Border BackgroundColor="{StaticResource Light}"
                           Padding="5"
                           HeightRequest="200"
                           StrokeShape="RoundRectangle 10"
                           Stroke="#E0E0E0">
                        <ScrollView>
                            <CollectionView ItemsSource="{Binding FilteredUsers}"
                                          SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:User">
                                        <Border Margin="5"
                                               Padding="15"
                                               BackgroundColor="White"
                                               StrokeShape="RoundRectangle 10"
                                               Stroke="{Binding IsSelected, Converter={StaticResource SelectedColorConverter}}">
                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectUserCommand}"
                                                    CommandParameter="{Binding .}"/>
                                            </Border.GestureRecognizers>
                                            <Grid ColumnDefinitions="Auto,*">
                                                <Border
                                                    BackgroundColor="{StaticResource Gray200}"
                                                    HeightRequest="50"
                                                    StrokeShape="RoundRectangle 25"
                                                    StrokeThickness="2"
                                                    VerticalOptions="Center"
                                                    WidthRequest="50">
                                                    <Image
                                                        Aspect="AspectFill"
                                                        Source="{Binding PhotoUrl, TargetNullValue='user_placeholder.svg', FallbackValue='user_placeholder.svg'}" />
                                                </Border>
                                                <VerticalStackLayout Grid.Column="1"
                                                                   Margin="10,0,0,0">
                                                    <Label Text="{Binding DisplayName}"
                                                           FontSize="16"
                                                           FontAttributes="Bold"
                                                           TextColor="{StaticResource Dark}"/>
                                                    <Label Text="{Binding Email}"
                                                           FontSize="12"
                                                           TextColor="{StaticResource Gray}"/>
                                                </VerticalStackLayout>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </ScrollView>
                    </Border>

                    <!-- Usuario seleccionado -->
                    <Border IsVisible="{Binding SelectedUser, Converter={StaticResource NullToBoolConverter}}"
                           BackgroundColor="{StaticResource Gray100}"
                           Padding="15"
                           StrokeShape="RoundRectangle 10"
                           Stroke="#2ECC71">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <Label Text="âœ…"
                                   FontSize="25"
                                   VerticalOptions="Center"/>
                            <VerticalStackLayout Grid.Column="1"
                                               Margin="10,0">
                                <Label Text="Enviar a:"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray}"/>
                                <Label Text="{Binding SelectedUser.DisplayName}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}"/>
                            </VerticalStackLayout>
                            <Button Grid.Column="2"
                                    Text="âœ•"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource Danger}"
                                    FontSize="20"
                                    Command="{Binding SelectUserCommand}"
                                    CommandParameter="{x:Null}"
                                    WidthRequest="40"
                                    HeightRequest="40"/>
                        </Grid>
                    </Border>

                    <!-- Cantidad de puntos -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Cantidad de puntos"
                               FontSize="14"
                               TextColor="{StaticResource Gray}"/>
                        <Entry Placeholder="Ingresa la cantidad..."
                               Text="{Binding PointsToTransfer}"
                               Keyboard="Numeric"
                               BackgroundColor="{StaticResource Light}"/>
                    </VerticalStackLayout>

                    <!-- DescripciÃ³n (opcional) -->
                    <VerticalStackLayout Spacing="5">
                        <Label Text="Mensaje (opcional)"
                               FontSize="14"
                               TextColor="{StaticResource Gray}"/>
                        <Editor Placeholder="AÃ±ade un mensaje..."
                                Text="{Binding Description}"
                                BackgroundColor="{StaticResource Light}"
                                HeightRequest="80"/>
                    </VerticalStackLayout>

                    <!-- Mensaje de error -->
                    <Label Text="{Binding ErrorMessage}"
                           TextColor="{StaticResource Danger}"
                           FontSize="14"
                           IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                           HorizontalOptions="Center"/>

                    <!-- BotÃ³n de transferir -->
                    <Button Text="Transferir Puntos"
                            Command="{Binding TransferPointsCommand}"
                            IsEnabled="{Binding CanTransfer}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            FontAttributes="Bold"
                            HeightRequest="50"
                            CornerRadius="25">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button"
                                       Binding="{Binding CanTransfer}"
                                       Value="False">
                                <Setter Property="BackgroundColor" Value="#95A5A6"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>

                </VerticalStackLayout>
            </Border>

            <!-- InformaciÃ³n adicional -->
            <Border Style="{StaticResource CardFrame}"
                   BackgroundColor="#FFF9E6"
                   Padding="15">
                <Grid ColumnDefinitions="Auto,*">
                    <Label Text="ðŸ’¡"
                           FontSize="25"/>
                    <VerticalStackLayout Grid.Column="1"
                                       Margin="10,0,0,0">
                        <Label Text="InformaciÃ³n"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Warning}"/>
                        <Label Text="Las transferencias son instantÃ¡neas y no se pueden revertir. AsegÃºrate de seleccionar el usuario correcto."
                               FontSize="12"
                               TextColor="{StaticResource Gray}"/>
                    </VerticalStackLayout>
                </Grid>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</views:BasePage>
