<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage
    BackgroundColor="{AppThemeBinding Light={StaticResource Light},
                                      Dark={StaticResource Gray950}}"
    Shell.NavBarIsVisible="False"
    Title="{Binding Title}"
    x:Class="AcuPuntos.Views.TransferPage"
    x:DataType="viewmodels:TransferViewModel"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:controls="clr-namespace:AcuPuntos.Views.Controls"
    xmlns:models="clr-namespace:AcuPuntos.Models"
    xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
    xmlns:views="clr-namespace:AcuPuntos.Views"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <Grid RowDefinitions="Auto,*">
        <!--  Header Background Shape  -->
        <BoxView
            Color="{StaticResource Primary}"
            Grid.RowSpan="2"
            HeightRequest="200"
            VerticalOptions="Start" />

        <RefreshView
            Command="{Binding RefreshDataCommand}"
            Grid.RowSpan="2"
            IsRefreshing="{Binding IsBusy}"
            RefreshColor="White">
            <ScrollView>
                <VerticalStackLayout Padding="24" Spacing="24">

                    <!--  Card de saldo actual  -->
                    <Grid Margin="0,10,0,0">
                        <Border
                            BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceAlpha},
                                                              Dark={StaticResource Gray900}}"
                            Padding="24"
                            StrokeThickness="0"
                            Style="{StaticResource CardFrame}">
                            <Grid ColumnDefinitions="*,Auto">
                                <VerticalStackLayout Spacing="4">
                                    <Label
                                        FontSize="14"
                                        Opacity="0.9"
                                        Text="Tu saldo actual"
                                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                                    Dark={StaticResource White}}" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontFamily="OpenSansBold"
                                        FontSize="42"
                                        Text="{Binding CurrentUser.Points, StringFormat='{0:N0}'}"
                                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDark},
                                                                    Dark={StaticResource PrimaryLight}}" />
                                </VerticalStackLayout>
                                <Label
                                    FontSize="56"
                                    Grid.Column="1"
                                    Text="ðŸ’°"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </Grid>

                    <!--  Formulario de transferencia  -->
                    <Border
                        BackgroundColor="{AppThemeBinding Light={StaticResource Surface},
                                                          Dark={StaticResource Gray900}}"
                        Padding="24"
                        Style="{StaticResource CardFrame}">
                        <VerticalStackLayout Spacing="24">

                            <Label
                                FontAttributes="Bold"
                                FontSize="20"
                                Text="Transferir Puntos"
                                TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                            Dark={StaticResource White}}" />

                            <!--  Campo de bÃºsqueda  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontSize="14"
                                    Text="Buscar usuario"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                Dark={StaticResource Gray400}}" />
                                <SearchBar
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Background},
                                                                      Dark={StaticResource Gray800}}"
                                    Placeholder="Nombre o email..."
                                    PlaceholderColor="{StaticResource Gray400}"
                                    Text="{Binding SearchText}"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                Dark={StaticResource White}}" />
                            </VerticalStackLayout>

                            <!--  Lista de usuarios  -->
                            <Border
                                BackgroundColor="{AppThemeBinding Light={StaticResource Background},
                                                                  Dark={StaticResource Gray800}}"
                                HeightRequest="220"
                                Padding="8"
                                StrokeShape="RoundRectangle 12"
                                StrokeThickness="0">
                                <ScrollView>
                                    <CollectionView ItemsSource="{Binding FilteredUsers}" SelectionMode="None">
                                        <CollectionView.EmptyView>
                                            <Label
                                                HorizontalOptions="Center"
                                                Margin="0,20"
                                                Text="No se encontraron usuarios"
                                                TextColor="{StaticResource Gray500}"
                                                VerticalOptions="Center" />
                                        </CollectionView.EmptyView>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:User">
                                                <Border
                                                    BackgroundColor="{AppThemeBinding Light={StaticResource Surface},
                                                                                      Dark={StaticResource Gray900}}"
                                                    Margin="0,4"
                                                    Padding="12"
                                                    StrokeShape="RoundRectangle 12"
                                                    StrokeThickness="2">
                                                    <Border.Stroke>
                                                        <MultiBinding Converter="{StaticResource UserSelectionConverter}">
                                                            <Binding Path="Uid" />
                                                            <Binding Path="BindingContext.SelectedUser.Uid" Source="{RelativeSource AncestorType={x:Type ContentPage}}" />
                                                        </MultiBinding>
                                                    </Border.Stroke>
                                                    <Border.GestureRecognizers>
                                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectUserCommand}" CommandParameter="{Binding .}" />
                                                    </Border.GestureRecognizers>
                                                    <Grid ColumnDefinitions="Auto,*">
                                                        <Border
                                                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray200},
                                                                                              Dark={StaticResource Gray700}}"
                                                            HeightRequest="48"
                                                            StrokeShape="RoundRectangle 24"
                                                            StrokeThickness="0"
                                                            VerticalOptions="Center"
                                                            WidthRequest="48">
                                                            <Image Aspect="AspectFill" Source="{Binding PhotoUrl, TargetNullValue='user_placeholder.svg', FallbackValue='user_placeholder.svg'}" />
                                                        </Border>
                                                        <VerticalStackLayout
                                                            Grid.Column="1"
                                                            Margin="12,0,0,0"
                                                            Spacing="2"
                                                            VerticalOptions="Center">
                                                            <Label
                                                                FontAttributes="Bold"
                                                                FontSize="15"
                                                                Text="{Binding DisplayName}"
                                                                TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                                            Dark={StaticResource White}}" />
                                                            <Label
                                                                FontSize="12"
                                                                Text="{Binding Email}"
                                                                TextColor="{AppThemeBinding Light={StaticResource Gray500},
                                                                                            Dark={StaticResource Gray400}}" />
                                                        </VerticalStackLayout>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </ScrollView>
                            </Border>

                            <!--  Usuario seleccionado  -->
                            <Border
                                BackgroundColor="{StaticResource SuccessLight}"
                                IsVisible="{Binding SelectedUser, Converter={StaticResource NullToBoolConverter}}"
                                Padding="16"
                                Stroke="{StaticResource Success}"
                                StrokeShape="RoundRectangle 12"
                                StrokeThickness="1">
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                    <Label
                                        FontSize="24"
                                        Text="âœ…"
                                        VerticalOptions="Center" />
                                    <VerticalStackLayout Grid.Column="1">
                                        <Label
                                            FontSize="12"
                                            Text="Enviar a:"
                                            TextColor="{StaticResource SuccessDark}" />
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="16"
                                            Text="{Binding SelectedUser.DisplayName}"
                                            TextColor="{StaticResource SuccessDark}" />
                                    </VerticalStackLayout>
                                    <Button
                                        BackgroundColor="Transparent"
                                        Command="{Binding SelectUserCommand}"
                                        CommandParameter="{x:Null}"
                                        FontSize="18"
                                        Grid.Column="2"
                                        HeightRequest="40"
                                        Padding="0"
                                        Text="âœ•"
                                        TextColor="{StaticResource SuccessDark}"
                                        WidthRequest="40" />
                                </Grid>
                            </Border>

                            <!--  Cantidad de puntos  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontSize="14"
                                    Text="Cantidad de puntos"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                Dark={StaticResource Gray400}}" />
                                <Entry
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Background},
                                                                      Dark={StaticResource Gray800}}"
                                    Keyboard="Numeric"
                                    Placeholder="Ingresa la cantidad..."
                                    PlaceholderColor="{StaticResource Gray400}"
                                    Text="{Binding PointsToTransfer}"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                Dark={StaticResource White}}" />
                            </VerticalStackLayout>

                            <!--  DescripciÃ³n (opcional)  -->
                            <VerticalStackLayout Spacing="8">
                                <Label
                                    FontSize="14"
                                    Text="Mensaje (opcional)"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray600},
                                                                Dark={StaticResource Gray400}}" />
                                <Editor
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Background},
                                                                      Dark={StaticResource Gray800}}"
                                    HeightRequest="80"
                                    Placeholder="AÃ±ade un mensaje..."
                                    PlaceholderColor="{StaticResource Gray400}"
                                    Text="{Binding Description}"
                                    TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                Dark={StaticResource White}}" />
                            </VerticalStackLayout>

                            <!--  Mensaje de error  -->
                            <Label
                                FontSize="14"
                                HorizontalOptions="Center"
                                IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}"
                                Text="{Binding ErrorMessage}"
                                TextColor="{StaticResource Danger}" />

                            <!--  BotÃ³n de transferir  -->
                            <Button
                                Command="{Binding TransferPointsCommand}"
                                HeightRequest="52"
                                IsEnabled="{Binding CanTransfer}"
                                Style="{StaticResource PrimaryButton}"
                                Text="Transferir Puntos">
                                <Button.Triggers>
                                    <DataTrigger
                                        Binding="{Binding CanTransfer}"
                                        TargetType="Button"
                                        Value="False">
                                        <Setter Property="BackgroundColor" Value="{StaticResource Gray300}" />
                                        <Setter Property="TextColor" Value="{StaticResource Gray500}" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>

                        </VerticalStackLayout>
                    </Border>

                    <!--  InformaciÃ³n adicional  -->
                    <Border
                        BackgroundColor="{StaticResource WarningLight}"
                        Padding="16"
                        StrokeThickness="0"
                        Style="{StaticResource CardFrame}">
                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="16">
                            <Label
                                FontSize="28"
                                Text="ðŸ’¡"
                                VerticalOptions="Start" />
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="14"
                                    Text="InformaciÃ³n"
                                    TextColor="{StaticResource WarningDark}" />
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="Las transferencias son instantÃ¡neas y no se pueden revertir. AsegÃºrate de seleccionar el usuario correcto."
                                    TextColor="{StaticResource WarningDark}" />
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <!--  Loading Overlay Reutilizable  -->
        <controls:LoadingOverlay Grid.RowSpan="2" />
    </Grid>
</views:BasePage>
