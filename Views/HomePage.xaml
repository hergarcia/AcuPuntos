<?xml version="1.0" encoding="utf-8" ?>
<views:BasePage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:AcuPuntos.Views"
             xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
             xmlns:models="clr-namespace:AcuPuntos.Models"
             x:Class="AcuPuntos.Views.HomePage"
             x:DataType="viewmodels:HomeViewModel"
             Title="{Binding Title}"
             BackgroundColor="#F5F5F5">

    <RefreshView Command="{Binding RefreshDataCommand}"
                 IsRefreshing="{Binding IsBusy}"
                 RefreshColor="#2ECC71">
        
        <ScrollView>
            <VerticalStackLayout Spacing="20" Padding="20">
                
                <!-- Saludo y nombre de usuario -->
                <VerticalStackLayout Spacing="5">
                    <Label Text="{Binding GreetingMessage}"
                           FontSize="24"
                           TextColor="#666666"/>
                    <Label Text="{Binding CurrentUser.DisplayName}"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="#333333"/>
                </VerticalStackLayout>

                <!-- Card de Puntos -->
                <Border Style="{StaticResource CardFrame}"
                       BackgroundColor="#2ECC71"
                       Padding="25">
                    <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                        <Label Text="Tus Puntos"
                               TextColor="White"
                               FontSize="18"
                               Opacity="0.9"/>
                        <Label Grid.Row="1" 
                               Text="{Binding PointsDisplay}"
                               TextColor="White"
                               FontSize="48"
                               FontAttributes="Bold"/>
                        <Label Grid.Row="2"
                               Text="puntos disponibles"
                               TextColor="White"
                               FontSize="14"
                               Opacity="0.8"/>
                        <Label Grid.Column="1"
                               Grid.RowSpan="3"
                               Text=""
                               FontSize="80"
                               VerticalOptions="Center"/>
                    </Grid>
                </Border>

                <!-- Botones de acciones r谩pidas -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="10" RowSpacing="10">
                    <!-- Bot贸n Transferir -->
                    <Border Grid.Column="0"
                           Style="{StaticResource CardFrame}"
                           Padding="15">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToTransferCommand}"/>
                        </Border.GestureRecognizers>
                        <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                            <Label Text="★"
                                   FontSize="40"
                                   HorizontalOptions="Center"/>
                            <Label Text="Transferir"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#333333"
                                   HorizontalOptions="Center"/>
                            <Label Text="Env铆a puntos"
                                   FontSize="12"
                                   TextColor="#666666"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Bot贸n Recompensas -->
                    <Border Grid.Column="1"
                           Style="{StaticResource CardFrame}"
                           Padding="15">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToRewardsCommand}"/>
                        </Border.GestureRecognizers>
                        <VerticalStackLayout Spacing="10" HorizontalOptions="Center">
                            <Label Text=""
                                   FontSize="40"
                                   HorizontalOptions="Center"/>
                            <Label Text="Recompensas"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#333333"
                                   HorizontalOptions="Center"/>
                            <Label Text="Canjea puntos"
                                   FontSize="12"
                                   TextColor="#666666"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!-- Transacciones recientes -->
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="Actividad Reciente"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="#333333"/>
                        <Label Grid.Column="1"
                               Text="Ver todo"
                               TextColor="#2ECC71"
                               FontSize="14"
                               VerticalOptions="Center">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding GoToHistoryCommand}"/>
                            </Label.GestureRecognizers>
                        </Label>
                    </Grid>

                    <!-- Lista de transacciones -->
                    <VerticalStackLayout IsVisible="{Binding HasTransactions}">
                        <CollectionView ItemsSource="{Binding RecentTransactions}"
                                      SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Transaction">
                                    <Border Style="{StaticResource CardFrame}"
                                           Padding="15"
                                           Margin="0,5">
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                                            <!-- Icono -->
                                            <Label Text="{Binding Icon}"
                                                   FontSize="30"
                                                   VerticalOptions="Center"/>

                                            <!-- Informaci贸n -->
                                            <VerticalStackLayout Grid.Column="1"
                                                               VerticalOptions="Center"
                                                               Spacing="3">
                                                <Label Text="{Binding Description}"
                                                       FontSize="16"
                                                       TextColor="#333333"
                                                       FontAttributes="Bold"/>
                                                <Label Text="{Binding CreatedAt, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                                       FontSize="12"
                                                       TextColor="#666666"/>
                                            </VerticalStackLayout>

                                            <!-- Monto -->
                                            <Label Grid.Column="2"
                                                   Text="{Binding FormattedAmount}"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label"
                                                               Binding="{Binding Type}"
                                                               Value="Reward">
                                                        <Setter Property="TextColor" Value="#2ECC71"/>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label"
                                                               Binding="{Binding Type}"
                                                               Value="Received">
                                                        <Setter Property="TextColor" Value="#2ECC71"/>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label"
                                                               Binding="{Binding Type}"
                                                               Value="Redemption">
                                                        <Setter Property="TextColor" Value="#E74C3C"/>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label"
                                                               Binding="{Binding Type}"
                                                               Value="Sent">
                                                        <Setter Property="TextColor" Value="#E74C3C"/>
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Sin transacciones -->
                    <Border Style="{StaticResource CardFrame}"
                           IsVisible="{Binding HasTransactions, Converter={StaticResource InvertedBoolConverter}}"
                           Padding="30">
                        <VerticalStackLayout Spacing="10">
                            <Label Text=""
                                   FontSize="50"
                                   HorizontalOptions="Center"/>
                            <Label Text="No hay actividad reciente"
                                   FontSize="16"
                                   TextColor="#666666"
                                   HorizontalOptions="Center"/>
                            <Label Text="Tus transacciones aparecer谩n aqu铆"
                                   FontSize="14"
                                   TextColor="#999999"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

                <!-- Panel de Admin (si es admin) -->
                <Border Style="{StaticResource CardFrame}"
                       BackgroundColor="#F39C12"
                       IsVisible="{Binding CurrentUser.IsAdmin}"
                       Padding="20">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GoToAdminCommand}"/>
                    </Border.GestureRecognizers>
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout>
                            <Label Text="Panel de Administraci贸n"
                                   TextColor="White"
                                   FontSize="18"
                                   FontAttributes="Bold"/>
                            <Label Text="Gestiona usuarios y recompensas"
                                   TextColor="White"
                                   FontSize="14"
                                   Opacity="0.9"/>
                        </VerticalStackLayout>
                        <Label Grid.Column="1"
                               Text="锔"
                               FontSize="40"
                               VerticalOptions="Center"/>
                    </Grid>
                </Border>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</views:BasePage>
