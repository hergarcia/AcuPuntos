<views:BasePage
    BackgroundColor="{AppThemeBinding Light={StaticResource Background},
                                      Dark={StaticResource Gray950}}"
    Shell.NavBarIsVisible="False"
    Title="{Binding Title}"
    x:Class="AcuPuntos.Views.HomePage"
    x:DataType="viewmodels:HomeViewModel"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:controls="clr-namespace:AcuPuntos.Views.Controls"
    xmlns:models="clr-namespace:AcuPuntos.Models"
    xmlns:viewmodels="clr-namespace:AcuPuntos.ViewModels"
    xmlns:views="clr-namespace:AcuPuntos.Views"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml">

    <Grid RowDefinitions="Auto,*">
        <!--  Header Background Shape  -->
        <BoxView
            Color="{StaticResource Primary}"
            Grid.RowSpan="2"
            HeightRequest="200"
            VerticalOptions="Start" />

        <RefreshView
            Command="{Binding RefreshDataCommand}"
            Grid.RowSpan="2"
            IsRefreshing="{Binding IsRefreshing}"
            RefreshColor="White">
            <ScrollView>
                <VerticalStackLayout Padding="24" Spacing="24">

                    <!--  Saludo y nombre de usuario  -->
                    <Grid ColumnDefinitions="*, Auto" Margin="0,10,0,20">
                        <VerticalStackLayout Spacing="4">
                            <Label
                                FontSize="16"
                                Text="{Binding GreetingMessage}"
                                TextColor="{AppThemeBinding Light={StaticResource PrimaryLight},
                                                            Dark={StaticResource Gray300}}" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="28"
                                Text="{Binding CurrentUser.DisplayName}"
                                TextColor="{AppThemeBinding Light=White,
                                                            Dark={StaticResource White}}" />
                        </VerticalStackLayout>
                        <Border
                            BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceAlpha},
                                                              Dark={StaticResource Gray900}}"
                            Grid.Column="1"
                            HeightRequest="48"
                            StrokeShape="RoundRectangle 24"
                            StrokeThickness="0"
                            WidthRequest="48">
                            <Grid>
                                <Image
                                    Aspect="AspectFill"
                                    IsVisible="{Binding CurrentUser.PhotoUrl, Converter={StaticResource StringToBoolConverter}}"
                                    Source="{Binding CurrentUser.PhotoUrl}" />
                                <Label
                                    FontSize="24"
                                    HorizontalOptions="Center"
                                    IsVisible="{Binding CurrentUser.PhotoUrl, Converter={StaticResource StringToBoolConverter}, ConverterParameter='Invert'}"
                                    Text="游녻"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </Grid>

                    <!--  Card de Puntos (Glassmorphism)  -->
                    <Grid>
                        <Border
                            BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceAlpha},
                                                              Dark={StaticResource Gray900}}"
                            IsVisible="{Binding IsNotBusy}"
                            Padding="0"
                            StrokeShape="RoundRectangle 24"
                            StrokeThickness="0">
                            <Grid
                                ColumnDefinitions="*,Auto"
                                Padding="24"
                                RowDefinitions="Auto,Auto,Auto">
                                <Label
                                    FontSize="16"
                                    Opacity="0.8"
                                    Text="Balance Total"
                                    TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                                Dark={StaticResource White}}" />
                                <Label
                                    FontAttributes="Bold"
                                    FontFamily="OpenSansSemibold"
                                    FontSize="42"
                                    Grid.Row="1"
                                    Text="{Binding PointsDisplay}"
                                    TextColor="{AppThemeBinding Light={StaticResource PrimaryDark},
                                                                Dark={StaticResource PrimaryLight}}" />
                                <Label
                                    FontSize="14"
                                    Grid.Row="2"
                                    Text="Puntos disponibles"
                                    TextColor="{StaticResource Gray600}" />
                                <Label
                                    FontSize="64"
                                    Grid.Column="1"
                                    Grid.RowSpan="3"
                                    Opacity="1"
                                    Text="游"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>
                        <controls:CardSkeleton IsVisible="{Binding IsBusy}" />
                    </Grid>

                    <!--  Card de Gamificaci칩n  -->
                    <Grid>
                        <Border
                            IsVisible="{Binding IsNotBusy}"
                            Padding="20"
                            Style="{StaticResource CardFrame}">
                            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="16">
                                <!--  Nivel y Progreso  -->
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="18"
                                        Text="{Binding CurrentUser.Level, StringFormat='Nivel {0}'}"
                                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                                    Dark={StaticResource White}}" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="14"
                                        Grid.Column="2"
                                        Text="{Binding CurrentUser.Experience, StringFormat='{0} XP'}"
                                        TextColor="{StaticResource Secondary}" />
                                </Grid>

                                <!--  Barra de progreso  -->
                                <ProgressBar
                                    Grid.Row="1"
                                    HeightRequest="8"
                                    Progress="{Binding LevelProgress}"
                                    ProgressColor="{StaticResource Secondary}" />

                                <!--  Check-in diario  -->
                                <Grid
                                    ColumnDefinitions="Auto,*,Auto"
                                    ColumnSpacing="16"
                                    Grid.Row="2">
                                    <Border
                                        BackgroundColor="{StaticResource Warning}"
                                        Padding="8"
                                        StrokeShape="RoundRectangle 12"
                                        StrokeThickness="0">
                                        <Label
                                            FontSize="20"
                                            Text="游댠"
                                            VerticalOptions="Center" />
                                    </Border>
                                    <VerticalStackLayout
                                        Grid.Column="1"
                                        Spacing="2"
                                        VerticalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="14"
                                            Text="{Binding ConsecutiveDays, StringFormat='Racha: {0} d칤as'}"
                                            TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                        Dark={StaticResource Gray900}}" />
                                        <Label
                                            FontSize="12"
                                            Text="춰Sigue as칤!"
                                            TextColor="{StaticResource Gray500}" />
                                    </VerticalStackLayout>
                                    <Button
                                        Command="{Binding DailyCheckInCommand}"
                                        CornerRadius="20"
                                        FontSize="12"
                                        Grid.Column="2"
                                        HeightRequest="40"
                                        IsEnabled="{Binding CanCheckIn}"
                                        Padding="16,0"
                                        Style="{StaticResource SecondaryButton}"
                                        Text="Check-in" />
                                </Grid>
                            </Grid>
                        </Border>
                        <controls:CardSkeleton IsVisible="{Binding IsBusy}" />
                    </Grid>

                    <!--  Botones de acciones r치pidas  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                        <!--  Bot칩n Transferir  -->
                        <Border
                            Grid.Column="0"
                            Padding="20"
                            Style="{StaticResource CardFrame}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding GoToTransferCommand}" />
                            </Border.GestureRecognizers>
                            <VerticalStackLayout HorizontalOptions="Center" Spacing="12">
                                <Border
                                    BackgroundColor="{StaticResource PrimaryLight}"
                                    HeightRequest="60"
                                    StrokeShape="RoundRectangle 20"
                                    StrokeThickness="0"
                                    WidthRequest="60">
                                    <Label
                                        FontSize="24"
                                        HorizontalOptions="Center"
                                        Text="俱뫮잺"
                                        VerticalOptions="Center" />
                                </Border>
                                <VerticalStackLayout Spacing="4">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        HorizontalOptions="Center"
                                        Text="Transferir"
                                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                                    Dark={StaticResource White}}" />
                                    <Label
                                        FontSize="12"
                                        HorizontalOptions="Center"
                                        Text="Enviar puntos"
                                        TextColor="{StaticResource Gray500}" />
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </Border>

                        <!--  Bot칩n Recompensas  -->
                        <Border
                            Grid.Column="1"
                            Padding="20"
                            Style="{StaticResource CardFrame}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding GoToRewardsCommand}" />
                            </Border.GestureRecognizers>
                            <VerticalStackLayout HorizontalOptions="Center" Spacing="12">
                                <Border
                                    BackgroundColor="{StaticResource SecondaryLight}"
                                    HeightRequest="60"
                                    StrokeShape="RoundRectangle 20"
                                    StrokeThickness="0"
                                    WidthRequest="60">
                                    <Label
                                        FontSize="24"
                                        HorizontalOptions="Center"
                                        Text="游꾸"
                                        VerticalOptions="Center" />
                                </Border>
                                <VerticalStackLayout Spacing="4">
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        HorizontalOptions="Center"
                                        Text="Canjear"
                                        TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                                    Dark={StaticResource White}}" />
                                    <Label
                                        FontSize="12"
                                        HorizontalOptions="Center"
                                        Text="Ver cat치logo"
                                        TextColor="{StaticResource Gray500}" />
                                </VerticalStackLayout>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!--  Transacciones recientes  -->
                    <VerticalStackLayout Spacing="12">
                        <Grid ColumnDefinitions="*,Auto" Margin="0,8">
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="Actividad Reciente"
                                TextColor="{AppThemeBinding Light={StaticResource PrimaryDarkText},
                                                            Dark={StaticResource White}}" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="14"
                                Grid.Column="1"
                                Text="Ver todo"
                                TextColor="{StaticResource Primary}"
                                VerticalOptions="Center">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding GoToHistoryCommand}" />
                                </Label.GestureRecognizers>
                            </Label>
                        </Grid>

                        <!--  Lista de transacciones  -->
                        <VerticalStackLayout IsVisible="{Binding IsNotBusy}">
                            <CollectionView
                                IsVisible="{Binding HasTransactions}"
                                ItemsSource="{Binding RecentTransactions}"
                                SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:Transaction">
                                        <Border Style="{StaticResource ListItemCard}">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                                                <!--  Icono  -->
                                                <Border
                                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100},
                                                                                      Dark={StaticResource Gray800}}"
                                                    HeightRequest="48"
                                                    StrokeShape="RoundRectangle 12"
                                                    StrokeThickness="0"
                                                    WidthRequest="48">
                                                    <Label
                                                        FontSize="20"
                                                        HorizontalOptions="Center"
                                                        Text="{Binding Icon}"
                                                        VerticalOptions="Center" />
                                                </Border>

                                                <!--  Informaci칩n  -->
                                                <VerticalStackLayout
                                                    Grid.Column="1"
                                                    Spacing="2"
                                                    VerticalOptions="Center">
                                                    <Label
                                                        FontAttributes="Bold"
                                                        FontSize="15"
                                                        LineBreakMode="TailTruncation"
                                                        Text="{Binding Description}"
                                                        TextColor="{AppThemeBinding Light={StaticResource Gray900},
                                                                                    Dark={StaticResource White}}" />
                                                    <Label
                                                        FontSize="12"
                                                        Text="{Binding CreatedAt, StringFormat='{0:dd MMM, HH:mm}'}"
                                                        TextColor="{StaticResource Gray500}" />
                                                </VerticalStackLayout>

                                                <!--  Monto  -->
                                                <Label
                                                    FontAttributes="Bold"
                                                    FontSize="16"
                                                    Grid.Column="2"
                                                    Text="{Binding FormattedAmount}"
                                                    VerticalOptions="Center">
                                                    <Label.Triggers>
                                                        <DataTrigger
                                                            Binding="{Binding Type}"
                                                            TargetType="Label"
                                                            Value="Reward">
                                                            <Setter Property="TextColor" Value="{StaticResource Success}" />
                                                        </DataTrigger>
                                                        <DataTrigger
                                                            Binding="{Binding Type}"
                                                            TargetType="Label"
                                                            Value="Received">
                                                            <Setter Property="TextColor" Value="{StaticResource Success}" />
                                                        </DataTrigger>
                                                        <DataTrigger
                                                            Binding="{Binding Type}"
                                                            TargetType="Label"
                                                            Value="Redemption">
                                                            <Setter Property="TextColor" Value="{StaticResource Danger}" />
                                                        </DataTrigger>
                                                        <DataTrigger
                                                            Binding="{Binding Type}"
                                                            TargetType="Label"
                                                            Value="Sent">
                                                            <Setter Property="TextColor" Value="{StaticResource Danger}" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <!--  Sin transacciones  -->
                            <controls:EmptyStateView
                                Icon="游늵"
                                IsVisible="{Binding HasTransactions, Converter={StaticResource InvertedBoolConverter}}"
                                Message="A칰n no tienes movimientos"
                                Title="Sin actividad" />
                        </VerticalStackLayout>

                        <!--  Skeleton Loading  -->
                        <controls:SkeletonList IsVisible="{Binding IsBusy}" />
                    </VerticalStackLayout>

                    <!--  Panel de Admin (si es admin)  -->
                    <Border
                        BackgroundColor="{StaticResource Warning}"
                        IsVisible="{Binding CurrentUser.IsAdmin}"
                        Margin="0,0,0,20"
                        Padding="20"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToAdminCommand}" />
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout>
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="18"
                                    Text="Panel de Administraci칩n"
                                    TextColor="White" />
                                <Label
                                    FontSize="14"
                                    Opacity="0.9"
                                    Text="Gestionar sistema"
                                    TextColor="White" />
                            </VerticalStackLayout>
                            <Label
                                FontSize="32"
                                Grid.Column="1"
                                Text="丘뙖잺"
                                VerticalOptions="Center" />
                        </Grid>
                    </Border>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>
    </Grid>
</views:BasePage>
